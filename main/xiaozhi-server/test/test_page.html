<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xiaozhi Server Test Page</title>
    <link rel="stylesheet" href="css/test_page.css">
    <script>
        // Detect if opened using file:// protocol
        if (window.location.protocol === 'file:') {
            document.addEventListener('DOMContentLoaded', function () {
                // Create warning box
                const warningDiv = document.createElement('div');
                warningDiv.id = 'fileProtocolWarning';
                warningDiv.innerHTML = `
                    <h2>‚ö†Ô∏è Warning: Please open this page using an HTTP server</h2>
                    <p>You are currently opening the page using local file method (file:// protocol), which may cause page functionality issues.</p>
                    <p>You can use nginx mapping to start the test page, or follow the steps below to use python to start the test http service:</p>
                    <ol>
                        <li>Open command line terminal</li>
                        <li>Navigate to xiaozhi-server/test directory in command line</li>
                        <li>Execute the following command to start HTTP server:</li>
                    </ol>
                    <pre>python -m http.server 8006</pre>
                    <p>Then access in browser: <strong>http://localhost:8006/test_page.html</strong></p>
                `;
                document.body.appendChild(warningDiv);
            });
        }
    </script>
</head>

<body>
    <div class="container">
        <div id="scriptStatus" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            Loading Opus library...
        </div>

        <!-- Two-column layout: device configuration and connection information -->
        <div class="two-column-layout">
            <!-- Device configuration panel -->
            <div class="section">
                <h2>
                    Device Configuration
                    <button class="toggle-button" id="toggleConfig">Edit</button>
                </h2>
                <div class="config-panel" id="configPanel">
                    <div class="control-panel">
                        <div class="config-row">
                            <div class="config-item">
                                <label for="deviceMac">Device MAC:</label>
                                <input type="text" id="deviceMac" placeholder="device-id" disabled>
                            </div>
                            <div class="config-item">
                                <label for="deviceName">Device Name:</label>
                                <input type="text" id="deviceName" value="Web Test Device" placeholder="deviceName" disabled>
                            </div>
                        </div>
                        <div class="config-row">
                            <div class="config-item">
                                <label for="clientId">Client ID:</label>
                                <input type="text" id="clientId" value="web_test_client" placeholder="client-id"
                                    disabled>
                            </div>
                            <div class="config-item">
                                <label for="token">Authentication Token:</label>
                                <input type="text" id="token" value="your-token1" placeholder="token" disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection information panel -->
            <div class="section">
                <h2>
                    Connection Information
                    <span class="connection-status">
                        <span id="otaStatus" class="status">‚óè OTA Not Connected</span>
                        <span id="connectionStatus" class="status">‚óè WS Not Connected</span>
                    </span>
                    <button class="connect-button" id="connectButton">
                        <span>‚óè</span>
                        Connect
                    </button>
                </h2>
                <div class="connection-controls">
                    <input type="text" id="otaUrl" value="http://127.0.0.1:8002/xiaozhi/ota/"
                        placeholder="OTA server address, e.g.: http://127.0.0.1:8002/xiaozhi/ota/" />
                    <input type="text" id="serverUrl" value="" readonly disabled placeholder="Automatically obtained from OTA interface after clicking connect button" />
                </div>
            </div>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" data-tab="text">Text Message</button>
                <button class="tab" data-tab="voice">Voice Message</button>
            </div>

            <div class="tab-content active" id="textTab">
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Enter message..." disabled>
                    <button id="sendTextButton" disabled>Send</button>
                </div>
            </div>

            <div class="tab-content" id="voiceTab">
                <div class="audio-controls">
                    <button id="recordButton" class="record-button" disabled>Start Recording</button>
                </div>
                <canvas id="audioVisualizer" class="audio-visualizer"></canvas>
            </div>

            <div style="margin: -10px 0px 5px 0px;">
                <span class="connection-status llm-emoji">
                    <span id="sessionStatus" class="status offline"><span class="emoji-large">üò∂</span> Xiaozhi Offline</span>
                </span>
            </div>
            <div class="flex-container">
                <div id="conversation" class="conversation"></div>
                <div id="logContainer">
                    <div class="log-entry log-info">Ready, please connect to server to start testing...</div>
                </div>
            </div>
        </div>

        <!-- MCP Tool Management Area -->
        <div class="section">
            <h2>
                MCP Tool Management
                <span class="connection-status">
                    <span id="mcpToolsCount">0 tools</span>
                </span>
                <button class="toggle-button" id="toggleMcpTools">Expand</button>
            </h2>
            <div class="config-panel" id="mcpToolsPanel">
                <div id="mcpToolsContainer" class="mcp-tools-container">
                    <!-- Tool list will be dynamically inserted here -->
                </div>
                <div style="text-align: center; padding: 15px 0;">
                    <button class="btn" id="addMcpToolBtn" style="background-color: #4caf50;">
                        ‚ûï Add New Tool
                    </button>
                </div>
            </div>
        </div>

        <!-- MCP Tool Edit Modal -->
        <div id="mcpToolModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; overflow-y: auto;">
            <div
                style="background-color: white; border-radius: 10px; padding: 25px; width: 90%; max-width: 700px; margin: 50px auto; max-height: 85vh; overflow-y: auto;">
                <div
                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                    <h2 id="mcpModalTitle" style="font-size: 20px; font-weight: bold; color: #333; margin: 0;">Add Tool</h2>
                    <button id="closeMcpModalBtn"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px;">&times;</button>
                </div>

                <div id="mcpErrorContainer"></div>

                <form id="mcpToolForm">
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px;">Tool Name
                            *</label>
                        <input type="text" id="mcpToolName" placeholder="e.g.: self.get_device_status" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px;">Tool Description
                            *</label>
                        <textarea id="mcpToolDescription" placeholder="Describe the tool's functionality and use cases in detail..." required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px;">Input Parameters</label>
                        <div
                            style="background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">
                            <div id="mcpPropertiesContainer">
                                <div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">
                                    No parameters yet, click the button below to add parameters</div>
                            </div>
                            <button type="button" id="addMcpPropertyBtn"
                                style="width: 100%; margin-top: 10px; padding: 8px 15px; border: none; border-radius: 5px; background-color: #2196f3; color: white; cursor: pointer; font-size: 14px;">
                                ‚ûï Add Parameter
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px;">
                            Mock Return Result (JSON format, optional)
                            <span style="font-size: 12px; color: #999; font-weight: normal;">- Leave empty to return default success message</span>
                        </label>
                        <textarea id="mcpMockResponse" placeholder='{"success": true, "data": "Execution successful"}'
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; font-family: 'Courier New', monospace; min-height: 100px; resize: vertical;"></textarea>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            üí° Tip: If mock return result is set, tool calls will return this JSON object
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                        <button type="button" id="cancelMcpBtn"
                            style="padding: 8px 15px; border: none; border-radius: 5px; background-color: #9e9e9e; color: white; cursor: pointer; font-size: 14px;">Cancel</button>
                        <button type="submit"
                            style="padding: 8px 15px; border: none; border-radius: 5px; background-color: #4caf50; color: white; cursor: pointer; font-size: 14px;">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Opus decoding library -->
    <script src="js/utils/libopus.js"></script>

    <!-- Main application entry -->
    <script type="module" src="js/app.js"></script>
</body>

</html>